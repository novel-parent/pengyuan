<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="renderer" content="webkit">
<meta name="viewport"
	content="width=device-width, initial-scale=1, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title></title>
<link rel="stylesheet" href="css/pintuer.css">
<link rel="stylesheet" href="css/admin.css">
<link rel="stylesheet" href="css/bootstrap.min.css">
<script src="js/jquery.js"></script>
<script src="js/pintuer.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<link rel="stylesheet" href="css/list.css">
<script type="text/javascript">

	$(function(){
		
		var searchString = window.location.search;
		
		var rowData = searchString.split('?')[1];
		
		var fid = rowData.split('&')[0].split('=')[1];
		
				
		
		//获取模板信息
		$.ajax({
			url:'addDataForProcedure.b',
			type:'post',
			data:'fid='+fid,
			success: function(data){
				if(data.code == -1){
					alert(data.msg);
				}else if(data.code == 1){
					
					
					var dataString = data.obj.main;
					
					var dataArr = parsepJsonString(dataString);
					
					
					var trName=new Date().getTime();
					
					//遍历工序模板信息
					for(let i=0;i<dataArr.length;i++){
						
						trName ++ ;
						
						var html = '';
						let name = dataArr[i].split(",")[0].split(":")[1];
						let price = dataArr[i].split(",")[1].split(":")[1];
						let num1 = dataArr[i].split(",")[2].split(":")[1];
						let uname1 = dataArr[i].split(",")[3].split(":")[1];
						let account1 = dataArr[i].split(",")[4].split(":")[1];
						let num2 = dataArr[i].split(",")[5].split(":")[1];
						let uname2 = dataArr[i].split(",")[6].split(":")[1];
						let account2 = dataArr[i].split(",")[7].split(":")[1]; 
						
						
						
						
						
						html+="<tr id='title_"+trName+"'>";
						html+="<td>"+name+"</td>";
						html+="<td>"+price+"</td>";
						html+="<td>"+num1+"</td>";
						html+="<td>"+uname1+"</td>";
						html+="<td>"+account1+"</td>";
						html+="<td>"+num2+"</td>";
						html+="<td>"+uname2+"</td>";
						html+="<td>"+account2+"</td>";
						html+="<td>";
						html+="<div class='button-group'>";
						html+="<a class='button border-main' href='javascript:void(0)' onclick='addProcedureData("+trName+")'><span class='icon-edit'></span>添加</a>";
						html+="<a class='button border-main' href='javascript:void(0)' onclick='edit("+trName+")'> <span class='icon-edit'></span> 修改</a>";
						html+="<a class='button border-red' href='javascript:void(0)' onclick='del("+trName+")'> <span class='icon-trash-o'></span>删除</a>";
						html+="</div>";
						html+="</td>";
						html+="</tr>";
						
						
						$("#procedureInfo").append(html);
					}
					
					var html = '';
					html+='<tr id="titleSave">';
					html+='<td colspan="15">';
					html+='<div class="pagelist">';
					html+='<div onclick="file.click()">';
					html+='<img src="images/timg.jfif" name="fileimg" style="width: 120px; height: 120px; left: 60px;" class="img-responsive" " alt="Cinque Terre" width="304" height="236">';
					html+='<div style="float: left;">';
					html+='<span>上传图片</span>';
					html+='</div>';
					html+='<input type="file" onchange="changeImg(this)" style="display: none" id="file">';
					html+='</div>';
					html+='<div class="button-group">';
					html+='<a class="button border-main" href="javascript:void(0)" onclick="saveProcedureInfo()" style="background-color: blue; color: white; width: 120px; text-decoration: none;"> 保存 </a>';
					html+='</div>';
					html+='</div>';
					html+='</td>';
					html+='</tr>';
					
					$("#procedureInfo").append(html);
					
					
					
					$("input[name = 'name']").val(data.obj.name);
					$("input[name = 'remark']").val(data.obj.remarks);
					 
				}
				
			}
		})
		
	})

	
	
	
	
	
	
	
	//解析Json数组
	function parsepJsonString(dataString){
		
		let m = indexOf(dataString,'[');
		let n = indexOf(dataString,']');
		
		var dataStr=dataString.substring(m+1,n);
		
		var tmpArr=dataStr.split('}');
		
		var dataArr = new Array();
		
		for(let j=0;j<tmpArr.length-1;j++){
			
			let tmpStr = tmpArr[j].split('{');
			
			dataArr[j-1] = tmpStr[1];
			
		}
		
		return dataArr;
	}
	
	//获取某一字符在字符串里面的位置
	function indexOf(str,value){
		var tmp = str.split('');
		for(var i=0;i<tmp.length;i++){
			if(tmp[i] == value){
				return i;
			}
		}
	}
	
</script>


</head>
<body>

	<div class="panel admin-panel">

		<div class="padding border-bottom">
			<ul class="search">
				<li>商品名称</li>
				<li><input type="text" name="name" onblur="checkName(this)" class="form-control"></li>
				<li>商品备注</li>
				<li><input type="text" name="remark" class="form-control"></li>
			</ul>
		</div>
		<table class="table table-hover text-center" name="procedureTable" id="procedureInfo">
			<tr id="titleBegin">
				<th width="120">工序</th>
				<th width="80">单价</th>
				<th width="100">数量</th>
				<th width="80">姓名</th>
				<th width="120">合计</th>
				<th width="100">数量</th>
				<th width="80">姓名</th>
				<th width="120">合计</th>
				<th width="220">操作</th>
			</tr>
			
			
			<!-- 工序列表内容 -->
			
			
		</table>
	</div>

	<!-- 添加的模态框 -->
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
		aria-labelledby="myModalLabel" aria-hidden="true" >
		<div class="modal-dialog" style="width:1000px;">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					添加工序信息
				</div>
				<div class="modal-body">
					<input type="hidden" name="trid" value="">
					
					<table class="table" >

						<thead>
							<tr>
								<th style="width:180px;">工序名</th>
								<th style="width:80px;">单价</th>
								<th style="width:90px;">数量</th>
								<th style="width:80px;">姓名</th>
								<th style="width:100px;">合计</th>
								<th style="width:90px;">数量</th>
								<th style="width:80px;">姓名</th>
								<th style="width:100px;">合计</th>
							</tr>
						</thead>
						<tbody>
							<tr id="trList">
								<td><input type="text" class="form-control"  id="proceduresName" disabled="disabled" ></td>
								<td><input type="text" class="form-control" id="proceduresPrice" disabled="disabled" ></td>
								<td><input type="text" class="form-control"  id="number1" placeholder="数量"  onkeyup="getAmmount(this.value,'account1')"></td>
								<td><input type="text" class="form-control" id="username1" placeholder="员工姓名"  ></td>
								<td><input type="text" class="form-control" id="account1" placeholder="总金额"  ></td>
								<!-- <td><input type="text" class="form-control" id="number2" placeholder="数量"  onkeyup="getAmmount(this.value,'account2')"></td>
								<td><input type="text" class="form-control" id="username2" placeholder="员工姓名"  ></td>
								<td><input type="text" class="form-control" id="account2" placeholder="总金额"  ></td> -->
								
							</tr>
						</tbody>
					</table>
				
					
						
					
						
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" onclick="nextStaff()" >下一员工</button>
				
					<button type="button" class="btn btn-default"  onclick="saveCurrentProcedure()">保存当前工序</button>
					
					<button type="button" class="btn btn-primary" onclick="nextProcedure()" >下一工序</button>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal -->
	</div>
	


	<script type="text/javascript">
	
		var pJsonStr = ''; 
		
		pJsonStrInit();
		
		//对pJsonStr的初始化
		function pJsonStrInit(){
			pJsonStr += '[{number:number,username:username,account:account}';
		}
	
		 
		//下一个员工的信息，从 <tr>里面读取
		function nextStaff(){
			
			var trid  =	$("input[name = 'trid']").val();
			
			//获取第一次输入的值
			let number1 = $("#number1").val();
			let username1 = $("#number1").val();
			let account1 = $("#account1").val();
			
			pJsonStr += ',{number1:'+number1+',username1:'+username1+',account1:'+account1+'}';
			
			var data = $('#'+trid).children();
			 
		 	
			let number2 = data.eq(5).html();
			let username2 = data.eq(6).html();
			let account2 = data.eq(7).html();
			
			
			$("#number2").val(number2);
			$("#username2").val(username2);
			$("#account2").val(account2);
			
		}
	
		//下一工序
		function nextProcedure(){
			
			//获取模态框的name为trid的值，该值为当前操作的 <tr> 的id 
			
			 var trid  =	$("input[name = 'trid']").val();
			
			/*
				把 模态框中 name = trid 的框的数字截取出来，因为 <tr> 的 id 是递增的，举个例子，第一个
				<tr> 的 id = title_1234567 则该 <tr>的紧接着的下一个 
				<tr>的   id = title_1234568  ， 再下一个 
				<tr> 的 id = title_12345679 。
				
			 */
			 trid = trid.substring(6,trid.length);
			 
			 trid = parseInt(trid);
			 
			 trid+=1;
			 
			 trid = 'title_'+trid;
			 
			 $("input[name = 'trid']").val(trid);
			 
			 //给 <tr> 的 <td> 赋值
			 
			 setTrOneVal(trid);
			 
			 
		}
		
		function setOneTrVal(trid){
			var data = $('#'+trid).children();
			 
		 	let name = data.eq(0).html();
			let price = data.eq(1).html();
			let number1 = data.eq(2).html();
			let username1 = data.eq(3).html();
			let account1 = data.eq(4).html();
			
			
			
			$("#proceduresName").val(name);
			$("#proceduresPrice").val(price);
			$("#number1").val(number1);
			$("#username1").val(username1);
			$("#account1").val(account1);
			
		}
		
		function setTrVal(trid){
			
			var data = $('#'+trid).children();

			
			let number2 = data.eq(5).html();
			let username2 = data.eq(6).html();
			let account2 = data.eq(7).html();
			
			$("#number2").val(number2);
			$("#username2").val(username2);
			$("#account2").val(account2);
			
			setOneTrVal(trid);
			
		}
	
		function saveCurrentProcedure(){
			
			
		    var trid  =	$("input[name = 'trid']").val();
			
		    var number1 = $('#number1').val();
		    var username1 = $('#username1').val().trim();
		    var account1 = $('#account1').val();
		    var number2 = $('#number1').val();
		    var username2 = $('#username2').val().trim();
		    var account2 = $('#account2').val();
		    
		    
		    var parrtten = /^\d{n}$/ ;
		    
		   
		    
		   
		    
		    if(number1 == ''){
		    	alert('请输入第一个工件数量');
		    	return;
		    }
		    if(username1 == ''){
		    	alert('请输入第一个员工姓名');
		    	return;
		    }
		    
		    if(number2 != '' && username2 == ''){
		    	alert('请输入第二个员工姓名');
		    	return;
		    }
		    
		    if(number2 == '' && username2 != ''){
		    	alert('请输入第二个工件数量');
		    	return;
		    }
		    
		    if(account1 == '' || account2 == ''){
		    	alert('请输入金额');
		    	return;
		    }
		    
		    if(username1 == username2){
		    	
		    	if(!confirm('两次输入的员工姓名相同,确认提交吗？')){
					return;		    		
		    	}
		    	
		    }
		    
		    if(!confirm('所有计算出来的金额仅供参考,保存前请确认无误')){
		    	return;
		    }
		    
		    
		    var trList = $('#'+trid).children();
		    
		    trList.eq(2).html(number1);
		    trList.eq(3).html(username1);
		    trList.eq(4).html(account1);
		    trList.eq(5).html(number2);
		    trList.eq(6).html(username2);
		    trList.eq(7).html(account2);
		    
		    alert('保存成功');
		    
		}
	
	
		function getAmmount(num,id){
			
			
				//单价
				var price = $("#proceduresPrice").val();
				
				//price转换位为数字类型
				price = Number(price);
				
				//price转换位为数字类型
				num = Number(num);
				
				let account = price*num;
				
				account = account;
				
				//保留小数点后三位小数，即 '离'
				account= Number(account).toFixed(3);
				
				
				
				$("#"+id).val(account);
				
		}
		
			//去除字符串尾部的0
		function removeTailZero(str){
			if(str.substring(str.length-1,str.length) == 0){
				str = str.substring(0,str.length-1);
				removeTailZero(str);
			}else{
				return str;
			}
		}
	
		

		//保存模板信息，上传到数据库
		function saveProcedureInfo() {
			
			var name=$("input[name='name']").val();
			var remark=$("input[name='remark']").val();
			var fd=new FormData();
			
		
			
			if(name == ''){
				alert('请输入模板名称');
				return;
			}
			
			if(remark == ''){
				alert('请输入备注');
				return;
			}
			
			
			var trList = $("tr[id ^= 'title']");

			var arr = "[{name:工序名,price:单价}";

			for (var i = 1; i < trList.size() - 1; i++) {

				var tdList = trList.eq(i).children();

				arr += ",{name:" + tdList.eq(0).html() + ",price:"
				+ tdList.eq(1).html() +",num1:"+tdList.eq(2).html()+",uname1:"+tdList.eq(3).html()+",account1:"+tdList.eq(4).html()
				+",num2:"+tdList.eq(5).html()+",uname2:"+tdList.eq(6).html()+",account2:"+tdList.eq(7).html()+"}"

			}

			arr += "]";
			
			if($("#file")[0].files[0] == null){
				if(!confirm('你还没有选择图片确认要保存该模板吗？')){
					return ;
				}
			}
			
			
			fd.append('name',name);
			fd.append('remarks',remark);
			fd.append('main',arr);
			fd.append('file',$("#file")[0].files[0]);
			
			console.log(fd.get('procedures'));
			
			console.log(fd.get('file'));
			
			$.ajax({
				url : 'SaveProcedureString.b',
				type : 'post',
				data : fd,
				processData: false,
				contentType: false,
				success : function(data) {
					if(data.code == 1){
						alert(data.msg);
						window.location.reload();
					}
				}
			})
			
		}
		
		
		//新增工序之前的相关操作
		function addProcedureData(obj) {
			
			$("input[name = 'trid']").val('title_'+obj);
			var trList = $("#trList").children();
			
			var trid = 'title_'+obj;
			
			setTrVal(trid);
			
			$("#myModal").modal('show');
			
			
		}
	
		//新增工序的保存方法
		function save() {
			
			let trName = new Date().getTime();
			
			let name = $("input[name = 'procedureName']").val();
			
			let price = $("input[name = 'procedurePrice']").val();
			
			let objName = $("input[name = 'trid']").val();
			
			
			let trObj = $("#"+objName);
			
			let html = '';
			
			html+="<tr id='title_"+trName+"'>";
			html+="<td>"+name+"</td>";
			html+="<td>"+price+"</td>";
			html+="<td></td>";
			html+="<td></td>";
			html+="<td></td>";
			html+="<td></td>";
			html+="<td></td>";
			html+="<td></td>";
			html+="<td>";
			html+="<div class='button-group'>";
			html+="<a class='button border-main' href='javascript:void(0)' onclick='addProcedure("+trName+")'><span class='icon-edit'></span>添加</a>";
			html+="<a class='button border-main' href='javascript:void(0)' onclick='edit("+trName+")'> <span class='icon-edit'></span> 修改</a>";
			html+="<a class='button border-red' href='javascript:void(0)' onclick='del("+trName+")'> <span class='icon-trash-o'></span>删除</a>";
			html+="</div>";
			html+="</td>";
			html+="</tr>";
			
			trObj.after(html);
			
			alert('添加成功');
			
			$("input[name = 'trid']").val('');
			
		}
		
		//编辑工序信息之前的相关操作
		function edit(obj){
			
			var objId = '#title_'+obj;
			
			var trList = $(objId).children();
			
			$("input[name = 'edittrid']").val(objId);
			
			$("input[name = 'afterEditProcedureName']").val(trList.eq(0).html());
			
			$("input[name = 'afterEditProcedurePrice']").val(trList.eq(1).html());
			
			$("#editModal").modal('show');
		}
		
		
		
		
		//隐藏模态框
		function cancel() {
			$("#myModal").modal('hide');
		}
		
		//	将用户上传的图片显示在页面上
		function changeImg(obj) {

			var url = getObjectURL(obj);

			$("img[name='fileimg']").attr('src', url);
		}

		//获取文件真实路径
		function getObjectURL(file) {
			var url = null;
			var fileObj = file.files[0];
			if (window.createObjcectURL != undefined) {
				url = window.createOjcectURL(fileObj);
			} else if (window.URL != undefined) {
				url = window.URL.createObjectURL(fileObj);
			} else if (window.webkitURL != undefined) {
				url = window.webkitURL.createObjectURL(fileObj);
			}
			return url;
		}
	</script>
</body>
</html>