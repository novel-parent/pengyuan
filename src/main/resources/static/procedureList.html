<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="renderer" content="webkit">
<title></title>
<link rel="stylesheet" href="css/pintuer.css">
<link rel="stylesheet" href="css/admin.css">
<script src="js/jquery.js"></script>
<script src="js/pintuer.js"></script>

<script type="text/javascript">
	 $(function(){
		
		$.ajax({
			url: 'serachAllDate.b',
			type: 'post',
			data: '',
			success: function(data){
				if(data.code == 1){
					
					for(var i=0;i<data.obj.length;i++){
						var html='';
						
						console.log(data.obj[i].times);
						
						var timeString = (''+data.obj[i].times).substring(0,4);
						
						html+='<option value="'+timeString+'">'+timeString+'</option>';
						
						$("select[name = 'year']").append(html);
					}
					
				}
			}
		})
		
		
		
	})
 
</script>


</head>
<body>
<form method="post" action="" id="listform">
  <div class="panel admin-panel">
    <div class="padding border-bottom">
      <ul class="search" style="padding-left:10px;">
        <li>
        
        名称: <input type="text" placeholder="请输入搜索关键字" name="name" onkeyup="ProcedureListsearch(1)" class="input" style="width:200px; line-height:17px;display:inline-block" />
          	
       &nbsp;&nbsp;&nbsp;&nbsp; 备注:  <input type="text" placeholder="请输入搜索关键字" name="remarks" onkeyup="ProcedureListsearch(1)" class="input" style="width:200px; line-height:17px;display:inline-block" />
        	
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 	
        	<select name="year" class="input"  style="width:120px; line-height:17px; display:inline-block">
            <option value="-1">请选择年份</option>
           
            
        </select>
     
          
        年&nbsp;&nbsp;	<select name="month" class="input" onchange="ProcedureListsearch(-1)" style="width:120px; line-height:17px; display:inline-block">
            <option value="-1">请选择月份</option><option value="01">1</option><option value="02">2</option><option value="03">3</option>
            <option value="04">4</option><option value="05">5</option><option value="06">6</option> <option value="07">7</option><option value="08">8</option>
            <option value="09">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
        </select>
       月 &nbsp;&nbsp;   <input type="text" placeholder="请输入日期" name="day"  class="input" style="width:120px; line-height:17px;display:inline-block" />
     日
     &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
          <a href="javascript:void(0)" class="button border-main icon-search" onclick="ProcedureListsearch(-1)" > 搜索</a></li>
    
      </ul>
    </div>
    
    
    <table class="table table-hover text-center" id="proceduresTable">
      <tr>
        <th width="10%" style="text-align:left; padding-left:40px;">模板名称</th>
        <th width="15%">备注</th>
        <th width="20%">图片</th>
        <th width="10%">时间</th>
        <th width="20%">操作</th>
      </tr>
      
      
   		
      
    </table>
  </div>
</form>
<script type="text/javascript">

	

	var totalPage;
	var currentPage = 1;
	
	function ProcedureListsearch(type){
		
		var name  = $("input[name = 'name']").val();
		var remarks = $("input[name = 'remarks']").val();
		var year = $("select[name = 'year']").val();
		var month = $("select[name = 'month']").val();
		var day = $("input[name = 'day']").val();
		
		
		
		var times = '';
		
		var flag='';
		
		let data = {};
		
		if(name != ''){
			data.name = name;
		}
		
		if(remarks != ''){
			data.remarks = remarks;
		}
		
		if(year != '-1'){
			times += year;
			flag += 'y';
		}
		if(month != '-1'){
			times += month;
			flag += 'm';
		}
		
		var parttern = /^\d{0,2}$/
		
		let f = parttern.test(day);
		
		if(parseInt(day) > 31 || !f){
			alert('请输入正确的日期格式');
			return;
		}
		
		if(day != ''){
			times += day
			flag += 'd';
		}
		
		
		if(times != ''){
		
			if(indexOf(flag,'y')>=0){
				
				if(indexOf(flag,'m')>=0){
					
					data.times = times;
					
				}else{
					alert('请先选择月份');
					flag='';
					return ;
				}
				
			}else{
				alert('请先选择年份');
				flag='';
				
				return ;
			}
		}
		
		data.currentPage = currentPage;
		
		
		$.ajax({
			url: 'getProcedureList.b',
			type: 'post',
			data: data,
			success : function (data){
				
				$("#proceduresTable").empty();
				
				var html = '';
				html+='<tr>';
				html+='<th width="10%" style="text-align:left; padding-left:40px;">模板名称</th>';
				html+='<th width="15%">备注</th>';
				html+='<th width="20%">图片</th>';
				html+='<th width="10%">时间</th>';
				html+='<th width="20%">操作</th>';
				html+='</tr>';
				
				$("#proceduresTable").append(html);
				
				if(data.code == 1){
					
					
					
					totalPage = data.totalPage;
					currentPage = data.currentPage;
					
					
					for(var i=0;i<data.obj.length;i++){
						
						var obj = data.obj[i];
						
						var html = '';
						
						var trName = new Date().getTime();
						
						var objYears = ('' + obj.times).substring(0,4);
						var objMonth = ('' + obj.times).substring(4,6);
						var objDay = ('' + obj.times).substring(6,8);
						
						var dateString = objYears+'/'+ objMonth + '/' +objDay;
						
						html+='<tr id="procedure_+'+trName+'">';
						html+='<td style="text-align:left; padding-left:40px;"> '+obj.name+'</td>';
						html+='<td>'+obj.remarks+'</td>';
						html+='<td width="10%"><img src="'+obj.path+'" alt="" width="70" height="50" /></td>';
						html+='<td>'+dateString+'</td>';
						html+='<td>';
						html+='<div class="button-group">';
						html+=' <a class="button border-main" href="procedureInfo.html?pid='+obj.pid+'"><span class="icon-edit"></span> 查看详情</a>';
						html+=' <a class="button border-red" href="javascript:void(0)" onclick="del(procedure_'+trName+','+obj.pid+')"><span class="icon-trash-o"></span> 删除</a>';
						html+='</div>';
						html+='</td>';
						html+='</tr>';
					
						$("#proceduresTable").append(html);
						
					}
					
						var html='';
						
						html+='<tr>';
						html+='<td colspan="8">';
						html+='<div class="pagelist">';
						html+=' <a onclick="firstPage()">首页</a>';
						html+=' <a onclick="prePage()">上一页</a>';
						html+='<span class="current">'+data.currentPage+'</span>';
						html+='<a onclick="nextPage()">下一页</a>';
						html+='<a onclick="lastPage()">尾页</a>';
						html+='<a >共'+data.totalPage+'页</a>';
						html+='</div>';
						html+='</td>';
						html+='</tr>';
						
						$("#proceduresTable").append(html);
					
				}else if(data.code == -1){
					if(type != 1){
						alert(data.msg);
					}
				}
			}
		})
		
}
	
	function firstPage(){
		currentPage = 1;
		ProcedureListsearch();
	}
	
	function prePage(){
		if((currentPage-1) <= 0){
			alert('当前已经是第一页');
			return;
		}
		currentPage --;
		ProcedureListsearch();
	}
	
	function nextPage(){
		if((currentPage+1) > totalPage ){
			alert('当前已经是最后一页');
			return;
		}
		currentPage ++;
		ProcedureListsearch();
	}
	
	function lastPage(){
		currentPage = totalPage;
		ProcedureListsearch();
	}
	
	function del(trid,pid){
		
		
		
		 $('#'+trid).css('display','none');
		
	}
	
	//查找某一字符在字符串中的位置，str为字符串，chr为字符，返回值为该字符在字符串中所处位置
	function indexOf(str,chr){
		
		var tmpArr = str.split('');
		
		for(var i=0;i<tmpArr.length;i++){
			if(tmpArr[i] == chr){
				return i;
			}
		}
		
		return -1;
	}

</script>
</body>
</html>