<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="renderer" content="webkit">
<title></title>
<link rel="stylesheet" href="css/pintuer.css">
<link rel="stylesheet" href="css/admin.css">
<script src="js/jquery.js"></script>
<script src="js/pintuer.js"></script>
<link rel="stylesheet" href="css/bootstrap.min.css">
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript">

$(function(){
	
	
	//加载工厂列表
	
	$.ajax({
		url:'getFactoryList.b',
		type:'post',
		data:'',
		success: function(data){
			var html='';
			html+='<option value="-1">请选择楼层</option>';
			
			$("#fid").append(html);
			
			
			$("#factory").append(html);
			
			
			for(var i=0;i<data.length;i++){
				var html='';
				
				html+='<option value="'+data[i].fid+'">'+data[i].factoryName+'</option>';
				
				$("#fid").append(html);
				
				
				$("#factory").append(html);
			}
		}
	})
	
	
	
	
})
	
			//加载编辑用户信息列表
			function edit(obj){
				$.ajax({
					url:'getUserInfo.b',
					type:'post',
					data: 'uid='+obj,
					success: function(data){
						
						$("input[name = 'uid']").val(obj);
						$("#name").val(data.userName);
						$("#tel").val(data.tel);
						$("#fid").val(data.factory.fid);
						$("#flag").val(data.flag);
						$("#myModal").modal('show');
					}
				})
			}


</script>

</head>
<body>
	<div id="myAlert" class="alert alert-success">
			<a href="#" class="close" data-dismiss="alert">&times;</a> <strong>admin你好！</strong>欢迎来到员工管理界面。
		</div>
		<div class="padding border-bottom ">
				<table class="table" >

							<tr >
								<td style="width:100px;">
								<input type="hidden" name="token" value=""/>
								<input type="text" class="form-control" onblur="searchUser()" data-toggle="tooltip" data-placement="top" title="请输入姓名"  style="width:120px;" name="name"
									placeholder="姓名"  ></td>
								<td style="width:100px;"><input type="text" onblur="searchUser()" data-toggle="tooltip" data-placement="top" title="请输入电话" class="form-control" style="width:120px;" name="tel"
									placeholder="电话" ></td>
								<td style="width:140px;"><select id="factory"
									class="form-control" onchange="searchUser()">
										
								</select></td>
								<td style="width:120px;">
									<select id="userStatus" class="form-control">
											<option value="1">在职</option>
											<option value="0" >离职</option>
									</select>
								</td>
								<td>
								<button type="button" class="btn btn-primary" onclick="searchUser()" >搜索</button>
								</td>
								<td>
								<button type="button" class="btn btn-primary" onclick="addUserBtn()" >添加员工</button>
								</td>
							</tr>
					</table>
					
		</div>


		
	<!-- 列表主体  -->
	<div class="table-responsive">
		<table class="table table-hover text-center myclass" id="usertable" >
			<tr >
				<th width="10%" >姓名</th>
				<th width="20%" >电话</th>
				<th width="15%" >所属工厂</th>
				<th width="20%" >在职状态</th>
				<th width="20%" >操作</th>
			</tr>

			<!-- 员工信息列表 -->
			
			
		</table>
		

	</div>

<!-- 模态框 -->
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
		aria-labelledby="myModalLabel" aria-hidden="true">
		
		<input type="hidden" name="uid" value="">
		
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title" id="myModalLabel">员工信息</h4>
				</div>
				<div class="modal-body">

					<table class="table" style="height:10px;">

						<thead>
							<tr>
								<th>姓名</th>
								<th>电话</th>
								<th>所属工厂</th>
								<th>在职状态</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td><input type="text" class="form-control" id="name"
									placeholder="请输入姓名" onblur="checkName(this.value)"></td>
								<td><input type="text" class="form-control" id="tel"
									placeholder="请输入电话" onblur="checkTel(this.value)"></td>
								<td style="margin-right: 20px;">
										<select class="form-control" style="width: 120px;" id="fid" >
											
											<!-- 工厂信息 -->
												
										</select>
								</td>
								<td style="margin-right: 20px;"><select id="flag"
									class="form-control" style="width: 90px;">
										<option value="1">在职</option>
										<option value="0">离职</option>
								</select></td>
							</tr>
						</tbody>
					</table>

				</div>
				<div class="modal-footer">
				
					<button type="button" class="btn btn-default" data-dismiss="modal">取消 </button>
					
					<button type="button" class="btn btn-primary"  id="savebtn">保存</button>
						
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal -->
	</div>
	
	<div  align="center">
		<ul class="pagination "  id="pageLine">
			<!-- 分页信息 -->
		</ul>
	</div>
	



	<script type="text/javascript">
	
	
	//token
	$.ajax({
		url:'getToken.b',
		data:'',
		type:'post',
		success: function(data){
			$("input[name^='token']").val(data);
		}
	})
	
	//获取token信息
	function getToken(){
		$.ajax({
			url:'getToken.b',
			data:'',
			type:'post',
			success: function(data){
				$("input[name^='token']").val(data);
			}
		})
	}
	
	function checkName(obj){
		
		if($("#name").val() ==  ''){
			alert("请输入姓名");			
		}
		
	}
	
	function checkTel(obj){
		
		var partten11 = /^\d{11}$/;
		var partten7 = /^\d{7}$/;
		
		var len = obj.length;
		
		if(len <=  7){
			
			if(!partten7.test(obj)){
				alert("此电话号码不为7位数字，请检查");
				return;
			}
			
		}else if(len <= 11){
			if(!partten11.test(obj)){
				alert("此电话号码不为11位数字，请检查");
				return;
			}
		}
		
	}
	
	//当前页
	var currentPage = 1;
	//总页数·
	var totalPage = 0;
	
	//查询员工
	function searchUser(){
		var name = $('input[name="name"]').val();
		var tel = $('input[name="tel"]').val();
		var fid = $('#factory').val();
		var flag = $('#userStatus').val();
		
			var data = {};
			
			if(name != null && name != ''){
				data.userName=name;
			}
			
			if(tel != '' && tel != null){
				data.tel=tel;
			}
			
			if(fid != '' && fid != null){
				data.fid=fid;
			}
			
			if(flag != null && flag != ''){
				data.flag = flag;
			}
			
			
			//当前页数
			data.pageNum=currentPage;
			
			
			$.ajax({
				url:'searchUser.b',
				type:'post',
				data:data,
				success: function(data){
					if(data.code == -1){
						
						alert(data.msg);
					}else if(data.code == 1){
						
						//清空之前的元素
						$("#usertable").empty();
						$("#pageLine").empty();
						
						//获取当前页
						currentPage=data.currentPage;
						//获取总页数
						totalPage=data.totalPage;
						
						var head='';
						head+='<tr>';
						head+='<th width="10%" >姓名</th>';
						head+='<th width="20%" >电话</th>';
						head+='<th width="15%" >所属工厂</th>';
						head+='<th width="20%" >在职状态</th>';
						head+='<th width="20%" >操作</th>';
						head+='</tr>';
						
						$("#usertable").append(head);
						
						
							
						for(var i=0;i<data.obj.length;i++){
							
							var listId = new Date().getTime();
							
							var user = data.obj[i];
							
							var flag='在职';
							
							if(user.flag == 0 ){
								flag='离职';
							}

							var html='';
							html+='<tr id=user_'+listId+'>';
							html+='<td>'+user.userName+'</td>';
							html+='<td>'+user.tel+'</td>';
							html+='<td >'+user.factory.factoryName+'</td>';
							html+='<td >'+flag+'</td>';
							html+='<td >';
							html+='<div class="button-group">';
							html+='<a class="button border-main" name="edi" onclick="edit('+user.uid+')"> <span class="icon-edit"></span> 修改</a>';
							html+=' <a class="button border-red" href="javascript:void(0)" onclick="del('+user.uid+','+listId+')">';
							html+='<span class="icon-trash-o"></span> 删除</a>';
							html+='</div>';
							html+='</td>';
							html+='</tr>';
							
							$("#usertable").append(html);
							
						}	
						
						
						
						var tool='';
						tool+='<li><a onclick="firstPage()">首页</a></li>';
						tool+='<li><a onclick="prePage()">上一页</a></li>';
						tool+='<li><a>'+data.currentPage+'</a></li>'
						tool+='<li><a onclick="nextPage()">下一页</a></li>';
						tool+='<li><a onclick="lastPage()">尾页</a></li>';
						tool+='<li><a >共'+data.totalPage+'页</a></li>'
						
						$("#pageLine").append(tool);
						
					}
				}
			})
			
		
	}
		//上一页
		function prePage(){
			if((currentPage-1)<=0){
				alert('当前已经是第一页');
				return;
			}else{
				currentPage--;
				searchUser();
			}
		}
		
		//下一页
		function nextPage(){
			if((currentPage+1)>totalPage){
				alert('当前已经是最后一页');
				return;
			}else{
				currentPage++;
				searchUser();
			}
		}
	
		//	首页
		function firstPage(){
			if((currentPage-1)<=0){
				alert("当前已是第一页");
				return;
			}else{
				currentPage=1;
				searchUser();
			}
		}
		//	尾页
		function lastPage(){
			if((currentPage+1)>totalPage){
				alert("当前已经是最后一页");
				return;
			}else{
				currentPage=totalPage;
				searchUser();
			}
		}
	
	//删除用户
		function del(uid,trId) {
			
			if (confirm("您确定要删除该员工吗?")) {
				
				var name = $('input[name="name"]').val();
				var tel = $('input[name="tel"]').val();
				var fid = $('#factory').val();
				var flag = $('#userStatus').val();
				
				$.ajax({
					url:'deleteUser.b/'+currentPage,
					type:'post',
					data:'uid='+uid,
					success: function(data){
						//code返回的是删除前的页码
						if(data.code > 0){
							
							currentPage = data.code;
							
							//使用删除前的页码再进行搜索
							searchUser();
							
							alert(data.msg);
						}else if(data.code == -1){
							alert(data.msg);
						}
					}
				})
			}
		}
		
		
		
		//更新或新增用户信息
		$("#savebtn").on('click',function(){
			
			var data;
			//判断电话是否为11位数字
			var partten11 = /^\d{11}$/;
			//判断电话是否为7位数字
			var partten7 = /^\d{7}$/;
			
			var len = $("#tel").val().length;
			
			//判断姓名是否为空
			if($("#name").val() == ''){
				alert("姓名不能为空");
				return;
			}
			
			//判断电话号码格式是否正确
			if(len <=  7){
				
				if(!partten7.test($("#tel").val())){
					if(!confirm("此电话号码格式不正确！确认提交吗？")){
						return;
					}
				}
				
			}else if(len <= 11){
				if(!partten11.test($("#tel").val())){
					if(!confirm("此电话号码格式不正确！确认提交吗？")){
						return;
					}
				}
			}
			
			
			//判断是否选择了工厂
			if($("#fid").val() == -1){
				alert('该员工还没有选择所属工厂！');
				return;
			}
			
			
			
			
			if($("input[name = 'uid']").val() == 0){
				data = {
						userName:$("#name").val(),
						tel:$("#tel").val(),
						fid:$("#fid").val(),
						flag:$("#flag").val(),
						token:$("input[name^='token']").val()
					}
			}else{
				data = {
						uid:$("input[name = 'uid']").val(),
						userName:$("#name").val(),
						tel:$("#tel").val(),
						fid:$("#fid").val(),
						flag:$("#flag").val()
					}
			}
			
			
				$.ajax({
					url:'updateUser.b',
					type:'post',
					data:data,
					success: function(data){
						if(data.code == 1){
							alert(data.msg);
							window.location.reload();
						}else if(data == -1){
							alert('请求失败');
							getToken();
						}
					}
				})
		})
		
		//点击新增用户按钮加载模态框的数据
		function addUserBtn(){
			
			$("input[name = 'uid']").val("0");
			$("#name").val('');
			$("#tel").val('');
			$("#fid").val('-1');
			$("#flag").val('1');
			
			$("#myModal").modal('show');
		}
		
		
	
	</script>

</body>
</html>